<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/freshplate/ui/pantry/PantryFragment.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/freshplate/ui/pantry/PantryFragment.java" />
              <option name="originalContent" value="package com.example.freshplate.ui.pantry;&#10;&#10;import android.os.Bundle;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.lifecycle.ViewModelProvider;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.navigation.fragment.NavHostFragment;&#10;import com.example.freshplate.R;&#10;import com.example.freshplate.data.model.PantryItem;&#10;import com.example.freshplate.databinding.FragmentPantryBinding; // Data Binding 生成的类&#10;import androidx.recyclerview.widget.ItemTouchHelper;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;import com.google.android.material.snackbar.Snackbar;&#10;import eightbitlab.com.blurview.BlurView;&#10;import eightbitlab.com.blurview.RenderScriptBlur;&#10;import eightbitlab.com.blurview.RenderEffectBlur;&#10;import android.os.Build;&#10;import android.graphics.Color;&#10;import android.graphics.drawable.Drawable;&#10;import android.view.ViewGroup;&#10;&#10;public class PantryFragment extends Fragment {&#10;&#10;    private PantryViewModel viewModel;&#10;    private FragmentPantryBinding binding;&#10;    private PantryAdapter adapter; // 你的 RecyclerView 适配器&#10;&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {&#10;        binding = FragmentPantryBinding.inflate(inflater, container, false);&#10;        viewModel = new ViewModelProvider(this).get(PantryViewModel.class);&#10;        binding.setViewModel(viewModel);&#10;        // 延后到 onViewCreated 再设置 LifecycleOwner，避免过早访问导致崩溃&#10;        // binding.setLifecycleOwner(getViewLifecycleOwner());&#10;&#10;        // 将 RecyclerView 初始化移到 onViewCreated，确保视图层级稳定&#10;        // setupRecyclerView();&#10;&#10;        return binding.getRoot();&#10;    }&#10;&#10;    @Override&#10;    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {&#10;        super.onViewCreated(view, savedInstanceState);&#10;        // 现在视图已创建，安全设置 LifecycleOwner&#10;        binding.setLifecycleOwner(getViewLifecycleOwner());&#10;&#10;        // 初始化 BlurView（在根内容之上模糊窗口背景）&#10;        setupBlurView();&#10;&#10;        // 1. 设置 RecyclerView&#10;        setupRecyclerView();&#10;&#10;        // 2. (核心) 观察 ViewModel 中的数据&#10;        viewModel.getFilteredItems().observe(getViewLifecycleOwner(), items -&gt; {&#10;            if (items != null) {&#10;                adapter.submitList(items);&#10;            }&#10;        });&#10;&#10;        // 3. (导航) 监听 &quot;+&quot; 按钮点击&#10;        viewModel.getNavigateToAddItemEvent().observe(getViewLifecycleOwner(), navigate -&gt; {&#10;            if (navigate) {&#10;                NavHostFragment.findNavController(this).navigate(R.id.action_pantryFragment_to_addItemFragment);&#10;                viewModel.onAddItemNavigated(); // 重置事件&#10;            }&#10;        });&#10;&#10;        // (!! 新增) 观察 &quot;item to delete&quot; 事件，用于显示 Undo Snack bar&#10;        viewModel.getItemToDelete().observe(getViewLifecycleOwner(), item -&gt; {&#10;            if (item != null) {&#10;                showUndoSnackbar(item);&#10;                viewModel.deleteEventHandled(); // 重置事件&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public void onDestroyView() {&#10;        super.onDestroyView();&#10;        // 防止内存泄漏&#10;        binding = null;&#10;    }&#10;&#10;    private void setupRecyclerView() {&#10;        adapter = new PantryAdapter();&#10;        adapter.setOnItemClickListener(item -&gt; {&#10;            // (!! 关键) 点击物品时，导航到 AddItemFragment 并传递 ID&#10;            Bundle args = new Bundle();&#10;            args.putInt(&quot;itemId&quot;, item.id);&#10;            NavHostFragment.findNavController(this).navigate(&#10;                    R.id.action_pantryFragment_to_addItemFragment,&#10;                    args&#10;            );&#10;        });&#10;        binding.rvPantryItems.setAdapter(adapter);&#10;        binding.rvPantryItems.setLayoutManager(new LinearLayoutManager(getContext()));&#10;        // (!! 关键) 在这里添加 ItemTouchHelper&#10;        new ItemTouchHelper(new ItemTouchHelper.SimpleCallback(0,&#10;                ItemTouchHelper.LEFT | ItemTouchHelper.RIGHT) {&#10;&#10;            @Override&#10;            public boolean onMove(@NonNull RecyclerView recyclerView,&#10;                                  @NonNull RecyclerView.ViewHolder viewHolder,&#10;                                  @NonNull RecyclerView.ViewHolder target) {&#10;                return false; // 我们不支持拖动排序&#10;            }&#10;&#10;            @Override&#10;            public void onSwiped(@NonNull RecyclerView.ViewHolder viewHolder, int direction) {&#10;                // 1. 获取被滑动的物品&#10;                int position = viewHolder.getBindingAdapterPosition();&#10;                PantryItem item = adapter.getCurrentList().get(position);&#10;&#10;                // 2. (!! 关键) 通知 ViewModel 删除物品&#10;                viewModel.deleteItem(item);&#10;            }&#10;        }).attachToRecyclerView(binding.rvPantryItems); // 将 &quot;滑动&quot; 功能附加到 RecyclerView;&#10;&#10;    }&#10;&#10;    private void setupBlurView() {&#10;        if (binding == null) return;&#10;        BlurView blurView = binding.blurView;&#10;        if (blurView == null) return;&#10;        View decorView = requireActivity().getWindow().getDecorView();&#10;        ViewGroup rootView = (ViewGroup) decorView.findViewById(android.R.id.content);&#10;        Drawable windowBackground = decorView.getBackground();&#10;        float radius = 20f;&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {&#10;            blurView.setupWith(rootView, new RenderEffectBlur())&#10;                    .setFrameClearDrawable(windowBackground)&#10;                    .setBlurRadius(radius)&#10;                    .setOverlayColor(Color.parseColor(&quot;#33FFFFFF&quot;));&#10;        } else {&#10;            blurView.setupWith(rootView, new RenderScriptBlur(requireContext()))&#10;                    .setFrameClearDrawable(windowBackground)&#10;                    .setBlurRadius(radius)&#10;                    .setOverlayColor(Color.parseColor(&quot;#33FFFFFF&quot;));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * (!! 新增) 显示一个带有 &quot;Undo&quot; 按钮的 Snack bar&#10;     */&#10;    private void showUndoSnackbar(PantryItem item) {&#10;        Snackbar.make(binding.getRoot(), &quot;Deleted &quot; + item.name, Snackbar.LENGTH_LONG)&#10;                .setAction(&quot;UNDO&quot;, v -&gt; {&#10;                    // (!! 关键) 通知 ViewModel 撤销删除&#10;                    viewModel.undoDelete(item);&#10;                })&#10;                .show();&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.freshplate.ui.pantry;&#10;&#10;import android.os.Bundle;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import androidx.annotation.NonNull;&#10;import androidx.annotation.Nullable;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.lifecycle.ViewModelProvider;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.navigation.fragment.NavHostFragment;&#10;import com.example.freshplate.R;&#10;import com.example.freshplate.data.model.PantryItem;&#10;import com.example.freshplate.databinding.FragmentPantryBinding; // Data Binding 生成的类&#10;import androidx.recyclerview.widget.ItemTouchHelper;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;import com.google.android.material.snackbar.Snackbar;&#10;import eightbitlab.com.blurview.BlurView;&#10;import eightbitlab.com.blurview.RenderScriptBlur;&#10;import eightbitlab.com.blurview.RenderEffectBlur;&#10;import android.os.Build;&#10;import android.graphics.Color;&#10;import android.graphics.drawable.Drawable;&#10;import android.view.ViewGroup;&#10;&#10;public class PantryFragment extends Fragment {&#10;&#10;    private PantryViewModel viewModel;&#10;    private FragmentPantryBinding binding;&#10;    private PantryAdapter adapter; // 你的 RecyclerView 适配器&#10;&#10;    @Override&#10;    public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {&#10;        binding = FragmentPantryBinding.inflate(inflater, container, false);&#10;        viewModel = new ViewModelProvider(this).get(PantryViewModel.class);&#10;        binding.setViewModel(viewModel);&#10;        // 延后到 onViewCreated 再设置 LifecycleOwner，避免过早访问导致崩溃&#10;        // binding.setLifecycleOwner(getViewLifecycleOwner());&#10;&#10;        // 将 RecyclerView 初始化移到 onViewCreated，确保视图层级稳定&#10;        // setupRecyclerView();&#10;&#10;        return binding.getRoot();&#10;    }&#10;&#10;    @Override&#10;    public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {&#10;        super.onViewCreated(view, savedInstanceState);&#10;        // 现在视图已创建，安全设置 LifecycleOwner&#10;        binding.setLifecycleOwner(getViewLifecycleOwner());&#10;&#10;        // 初始化 BlurView（在根内容之上模糊窗口背景）&#10;        setupBlurView();&#10;&#10;        // 1. 设置 RecyclerView&#10;        setupRecyclerView();&#10;&#10;        // 2. (核心) 观察 ViewModel 中的数据&#10;        viewModel.getFilteredItems().observe(getViewLifecycleOwner(), items -&gt; {&#10;            if (items != null) {&#10;                adapter.submitList(items);&#10;            }&#10;        });&#10;&#10;        // 3. (导航) 监听 &quot;+&quot; 按钮点击&#10;        viewModel.getNavigateToAddItemEvent().observe(getViewLifecycleOwner(), navigate -&gt; {&#10;            if (navigate) {&#10;                NavHostFragment.findNavController(this).navigate(R.id.action_pantryFragment_to_addItemFragment);&#10;                viewModel.onAddItemNavigated(); // 重置事件&#10;            }&#10;        });&#10;&#10;        // (!! 新增) 观察 &quot;item to delete&quot; 事件，用于显示 Undo Snack bar&#10;        viewModel.getItemToDelete().observe(getViewLifecycleOwner(), item -&gt; {&#10;            if (item != null) {&#10;                showUndoSnackbar(item);&#10;                viewModel.deleteEventHandled(); // 重置事件&#10;            }&#10;        });&#10;    }&#10;&#10;    @Override&#10;    public void onDestroyView() {&#10;        super.onDestroyView();&#10;        // 防止内存泄漏&#10;        binding = null;&#10;    }&#10;&#10;    private void setupRecyclerView() {&#10;        adapter = new PantryAdapter();&#10;        adapter.setOnItemClickListener(item -&gt; {&#10;            // (!! 关键) 点击物品时，导航到 AddItemFragment 并传递 ID&#10;            Bundle args = new Bundle();&#10;            args.putInt(&quot;itemId&quot;, item.id);&#10;            NavHostFragment.findNavController(this).navigate(&#10;                    R.id.action_pantryFragment_to_addItemFragment,&#10;                    args&#10;            );&#10;        });&#10;        binding.rvPantryItems.setAdapter(adapter);&#10;        binding.rvPantryItems.setLayoutManager(new LinearLayoutManager(getContext()));&#10;        // (!! 关键) 在这里添加 ItemTouchHelper&#10;        new ItemTouchHelper(new ItemTouchHelper.SimpleCallback(0,&#10;                ItemTouchHelper.LEFT | ItemTouchHelper.RIGHT) {&#10;&#10;            @Override&#10;            public boolean onMove(@NonNull RecyclerView recyclerView,&#10;                                  @NonNull RecyclerView.ViewHolder viewHolder,&#10;                                  @NonNull RecyclerView.ViewHolder target) {&#10;                return false; // 我们不支持拖动排序&#10;            }&#10;&#10;            @Override&#10;            public void onSwiped(@NonNull RecyclerView.ViewHolder viewHolder, int direction) {&#10;                // 1. 获取被滑动的物品&#10;                int position = viewHolder.getBindingAdapterPosition();&#10;                PantryItem item = adapter.getCurrentList().get(position);&#10;&#10;                // 2. (!! 关键) 通知 ViewModel 删除物品&#10;                viewModel.deleteItem(item);&#10;            }&#10;        }).attachToRecyclerView(binding.rvPantryItems); // 将 &quot;滑动&quot; 功能附加到 RecyclerView;&#10;&#10;    }&#10;&#10;    private void setupBlurView() {&#10;        if (binding == null) return;&#10;        BlurView blurView = binding.blurView;&#10;        if (blurView == null) return;&#10;        View decorView = requireActivity().getWindow().getDecorView();&#10;        ViewGroup rootView = (ViewGroup) decorView.findViewById(android.R.id.content);&#10;        Drawable windowBackground = decorView.getBackground();&#10;        float radius = 20f;&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S) {&#10;            blurView.setupWith(rootView, new RenderEffectBlur())&#10;                    .setFrameClearDrawable(windowBackground)&#10;                    .setBlurRadius(radius)&#10;                    .setOverlayColor(Color.parseColor(&quot;#33FFFFFF&quot;));&#10;        } else {&#10;            blurView.setupWith(rootView, new RenderScriptBlur(requireContext()))&#10;                    .setFrameClearDrawable(windowBackground)&#10;                    .setBlurRadius(radius)&#10;                    .setOverlayColor(Color.parseColor(&quot;#33FFFFFF&quot;));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * (!! 新增) 显示一个带有 &quot;Undo&quot; 按钮的 Snack bar&#10;     */&#10;    private void showUndoSnackbar(PantryItem item) {&#10;        Snackbar.make(binding.getRoot(), &quot;Deleted &quot; + item.name, Snackbar.LENGTH_LONG)&#10;                .setAction(&quot;UNDO&quot;, v -&gt; {&#10;                    // (!! 关键) 通知 ViewModel 撤销删除&#10;                    viewModel.undoDelete(item);&#10;                })&#10;                .show();&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>